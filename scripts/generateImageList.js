// scripts/generateImageList.js
const fs = require('fs');
const path = require('path');

const imagesBaseDir = path.join(__dirname, '../public/images');
const publicDir = path.join(__dirname, '../public');
const utilsDir = path.join(__dirname, '../utils');

// Ensure utils directory exists
if (!fs.existsSync(utilsDir)) {
    fs.mkdirSync(utilsDir);
}

const dirMapping = {
    '1-2': 'imageList-1-1.json',
    '2-1': 'imageList-1-2.json',
    '2-2': 'imageList-1-3.json'
};

// public/images ì•ˆì˜ ëª¨ë“  í´ë”ë¥¼ ì½ìŒ
const subDirs = fs.readdirSync(imagesBaseDir).filter(dir =>
    fs.statSync(path.join(imagesBaseDir, dir)).isDirectory()
);

// ê¸°ì¡´ imageList.json ì‚­ì œ (if exists)
const oldJsonPath = path.join(publicDir, 'imageList.json');
if (fs.existsSync(oldJsonPath)) {
    fs.unlinkSync(oldJsonPath);
    console.log('ğŸ—‘ï¸  ê¸°ì¡´ imageList.json ì‚­ì œ ì™„ë£Œ');
}

let allImageImports = [];
let allImageMapEntries = [];
let globalImageIndex = 0;

// ê° í´ë”ë³„ë¡œ ë³„ë„ì˜ JSON íŒŒì¼ì„ ìƒì„±í•˜ê³ , í†µí•© TS ë§µì„ ìœ„í•œ ë°ì´í„° ìˆ˜ì§‘
subDirs.forEach(dir => {
    const jsonFileName = dirMapping[dir];
    if (!jsonFileName) {
        console.log(`âš ï¸ ${dir}ì— ëŒ€í•œ ë§¤í•‘ì´ ì—†ì–´ ê±´ë„ˆëœë‹ˆë‹¤.`);
        return;
    }

    const imageFiles = fs.readdirSync(path.join(imagesBaseDir, dir))
        .filter(f => /\.(jpe?g|png)$/i.test(f));

    let imagePaths = [];
    imageFiles.forEach(oldName => {
        const nfcName = oldName.normalize('NFC');
        const oldPath = path.join(imagesBaseDir, dir, oldName);
        const newPath = path.join(imagesBaseDir, dir, nfcName);

        if (oldName !== nfcName) {
            fs.renameSync(oldPath, newPath);
            console.log(`ğŸ”„ rename: ${oldName} â†’ ${nfcName}`);
        }

        // dir/image.jpeg
        const relativePath = `${dir}/${nfcName}`;
        imagePaths.push(relativePath);

        // For TS generation
        // Use a simple counter to avoid naming collisions with non-ASCII characters
        const safeName = `img_${globalImageIndex++}`;

        // Import path relative to utils/imageMap.ts -> ../public/images/...
        allImageImports.push(`import ${safeName} from "../public/images/${relativePath}";`);
        allImageMapEntries.push(`  "${relativePath}": ${safeName},`);
    });

    imagePaths.sort();

    const jsonPath = path.join(publicDir, jsonFileName);

    // JSON ì‘ì„± (ê¸°ì¡´ í˜¸í™˜ì„± ìœ ì§€)
    fs.writeFileSync(jsonPath, JSON.stringify(imagePaths, null, 2), 'utf-8');
});

// Generate utils/imageMap.ts
const tsContent = `// This file is automatically generated by scripts/generateImageList.js
// Do not edit this file manually.

${allImageImports.join('\n')}

export const imageMap: Record<string, any> = {
${allImageMapEntries.join('\n')}
};
`;

const tsPath = path.join(utilsDir, 'imageMap.ts');
fs.writeFileSync(tsPath, tsContent, 'utf-8');
console.log(`âœ… utils/imageMap.ts ìƒì„± ì™„ë£Œ (${allImageImports.length} images)`);